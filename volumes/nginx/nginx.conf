worker_processes auto;

pid /run/nginx.pid;
error_log /dev/stderr warn;

events {
    worker_connections 1024;
}

http {
    ##
    # MIME + defaults
    ##
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    ##
    # Logging (QUIC-aware)
    ##
    log_format quic '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" "$http3"';

    access_log /var/log/nginx/access.log quic;

    ##
    # Security headers (from QUIC config)
    ##
    server_tokens off;
    more_clear_headers 'Server';
    more_clear_headers 'X-Powered-By';

    #more_set_headers 'X-Frame-Options: SAMEORIGIN';
    #more_set_headers 'X-XSS-Protection: 1; mode=block';
    #more_set_headers "Content-Security-Policy: object-src 'none'; frame-ancestors 'self'; form-action 'self'; block-all-mixed-content; sandbox allow-forms allow-same-origin allow-scripts allow-popups allow-downloads; base-uri 'self';";

    ##
    # SSL core knobs are provided by /etc/nginx/conf.d/ssl_common.conf
    # Do NOT redefine ssl_session_*, ssl_dhparam, ssl_stapling, ssl_protocols here
    ##

    ##
    # Compression (merged)
    ##
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 5;
    gzip_min_length 500k;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_types
        text/plain
        text/css
        application/json
        application/javascript
        text/xml
        application/xml
        application/xml+rss
        text/javascript
        application/octet-stream;

    brotli on;
    brotli_static on;

    zstd on;
    zstd_static on;

    ##
    # Buffers (from your config)
    ##
    large_client_header_buffers 4 16k;
    proxy_buffer_size          128k;
    proxy_buffers              4 256k;
    proxy_busy_buffers_size    256k;

    ##
    # Body size
    ##
    client_max_body_size 100M;

    ##
    # Keepalive + sendfile
    ##
    sendfile on;
    tcp_nopush on;
    keepalive_timeout 65;

    ##
    # Upgrade map (for websockets)
    ##
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    ##
    # Load additional configs
    ##
    include /etc/nginx/conf.d/*.conf;   # this pulls in ssl_common.conf
    include /etc/nginx/sites-enabled/*; # your sites
}
